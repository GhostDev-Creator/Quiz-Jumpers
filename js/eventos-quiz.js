const perguntasPorNivel = {
    1: [
        {
            texto: "Quem foi o primeiro homem a pisar na Lua?",
            respostas: ["Buzz Aldrin", "Neil Armstrong", "Yuri Gagarin", "Michael Collins"],
            correta: 1
        },
        {
            texto: "Em que país começou a construção das pirâmides do Egito?",
            respostas: ["Grécia", "Egito", "China", "Índia"],
            correta: 1
        },
        {
            texto: "A Segunda Guerra Mundial terminou em:",
            respostas: ["1945", "1939", "1918", "1960"],
            correta: 0
        },
        {
            texto: "Quem descobriu o Brasil em 1500?",
            respostas: ["Cristóvão Colombo", "Pedro Álvares Cabral", "Dom Pedro I", "Vasco da Gama"],
            correta: 1
        },
        {
            texto: "A Muralha da China foi construída em qual país?",
            respostas: ["Japão", "Índia", "China", "Coreia do Sul"],
            correta: 2
        },
        {
            texto: "A Primeira Guerra Mundial começou em:",
            respostas: ["1914", "1945", "1890", "1920"],
            correta: 0
        },
        {
            texto: "Quem era o líder da Alemanha durante a Segunda Guerra?",
            respostas: ["Napoleão", "Hitler", "Churchill", "Mussolini"],
            correta: 1
        },
        {
            texto: "Onde ocorreu o famoso naufrágio do navio Titanic?",
            respostas: ["Oceano Pacífico", "Mar Mediterrâneo", "Oceano Atlântico", "Mar do Norte"],
            correta: 2
        },
        {
            texto: "Qual cidade foi a primeira a ser atingida por uma bomba atômica?",
            respostas: ["Tóquio", "Hiroshima", "Osaka", "Nagasaki"],
            correta: 1
        },
        {
            texto: "A independência do Brasil foi proclamada por:",
            respostas: ["Dom Pedro I", "Getúlio Vargas", "Tiradentes", "Dom João VI"],
            correta: 0
        }
    ],

    2: [
        {
            texto: "O Império Romano caiu em aproximadamente:",
            respostas: ["476 d.C.", "100 d.C.", "800 d.C.", "1200 d.C."],
            correta: 0
        },
        {
            texto: "A Revolução Francesa começou em:",
            respostas: ["1789", "1500", "1815", "1650"],
            correta: 0
        },
        {
            texto: "Quem foi o primeiro presidente dos Estados Unidos?",
            respostas: ["Abraham Lincoln", "George Washington", "John Adams", "Thomas Jefferson"],
            correta: 1
        },
        {
            texto: "A bomba de Nagasaki foi lançada em:",
            respostas: ["1943", "1944", "1945", "1946"],
            correta: 2
        },
        {
            texto: "A Guerra Fria foi um conflito principalmente entre:",
            respostas: ["EUA e União Soviética", "China e Japão", "França e Alemanha", "Brasil e Argentina"],
            correta: 0
        },
        {
            texto: "A expansão marítima portuguesa começou no século:",
            respostas: ["XII", "XV", "XIX", "VIII"],
            correta: 1
        },
        {
            texto: "O Muro de Berlim caiu em:",
            respostas: ["1980", "1989", "1995", "1975"],
            correta: 1
        },
        {
            texto: "A escravidão no Brasil foi abolida em:",
            respostas: ["1822", "1888", "1900", "1865"],
            correta: 1
        },
        {
            texto: "Quem pintou o famoso quadro 'Guernica', inspirado na guerra?",
            respostas: ["Da Vinci", "Picasso", "Van Gogh", "Michelangelo"],
            correta: 1
        },
        {
            texto: "O Coliseu foi construído em qual cidade?",
            respostas: ["Atenas", "Roma", "Paris", "Istambul"],
            correta: 1
        }
    ],

    3: [
        {
            texto: "A Peste Negra devastou a Europa no século:",
            respostas: ["XIV", "XVI", "X", "XIX"],
            correta: 0
        },
        {
            texto: "Qual guerra foi desencadeada pelo assassinato do Arquiduque Francisco Ferdinando?",
            respostas: ["Guerra do Vietnã", "Primeira Guerra Mundial", "Guerra Fria", "Segunda Guerra Mundial"],
            correta: 1
        },
        {
            texto: "A Revolução Industrial começou em qual país?",
            respostas: ["Alemanha", "França", "Inglaterra", "Espanha"],
            correta: 2
        },
        {
            texto: "O Tratado de Versalhes foi assinado após:",
            respostas: ["Revolução Francesa", "Primeira Guerra Mundial", "Segunda Guerra Mundial", "Guerra Fria"],
            correta: 1
        },
        {
            texto: "Quem liderou a luta contra o apartheid na África do Sul?",
            respostas: ["Nelson Mandela", "Kofi Annan", "Malcolm X", "Obama"],
            correta: 0
        },
        {
            texto: "A “Rota da Seda” ligava principalmente a Europa ao:",
            respostas: ["Brasil", "Canadá", "Oriente", "África"],
            correta: 2
        },
        {
            texto: "O império asteca foi destruído por conquistadores de qual país?",
            respostas: ["Portugal", "Espanha", "França", "Inglaterra"],
            correta: 1
        },
        {
            texto: "A Guerra dos Cem Anos ocorreu entre:",
            respostas: ["Rússia e Suécia", "Espanha e Marrocos", "França e Inglaterra", "China e Mongólia"],
            correta: 2
        },
        {
            texto: "O Renascimento teve início em qual região?",
            respostas: ["Alemanha", "Itália", "Noruega", "Grécia"],
            correta: 1
        },
        {
            texto: "Quem foi o primeiro homem no espaço?",
            respostas: ["Neil Armstrong", "Yuri Gagarin", "Buzz Aldrin", "Laika"],
            correta: 1
        }
    ],

    4: [
        {
            texto: "O Império Bizantino caiu após a tomada de Constantinopla em:",
            respostas: ["1204", "1453", "1600", "1300"],
            correta: 1
        },
        {
            texto: "A Guerra do Peloponeso foi travada principalmente entre:",
            respostas: ["Roma e Cartago", "Atenas e Esparta", "Persas e Egípcios", "Macedônia e Creta"],
            correta: 1
        },
        {
            texto: "A Revolução Russa que instaurou o regime soviético ocorreu em:",
            respostas: ["1917", "1890", "1945", "1930"],
            correta: 0
        },
        {
            texto: "A Conferência de Yalta reorganizou o mundo após:",
            respostas: ["Guerra Fria", "Primeira Guerra", "Segunda Guerra", "Guerra da Crimeia"],
            correta: 2
        },
        {
            texto: "A unificação da Alemanha foi concluída por ação de qual líder?",
            respostas: ["Churchill", "Bismarck", "Napoleão", "Garibaldi"],
            correta: 1
        },
        {
            texto: "O movimento iluminista influenciou fortemente:",
            respostas: ["Revolução Francesa", "Guerra do Vietnã", "Descobrimento da América", "Início da Idade Média"],
            correta: 0
        },
        {
            texto: "A Grande Depressão teve início em 1929 com:",
            respostas: ["A falência da Kodak", "A queda da Bolsa de Nova York", "O fim da Primeira Guerra", "A crise do petróleo"],
            correta: 1
        },
        {
            texto: "O tratado que dividiu o mundo entre Espanha e Portugal foi o:",
            respostas: ["Tratado de Utrecht", "Tratado de Tordesilhas", "Tratado de Versalhes", "Tratado de Paris"],
            correta: 1
        },
        {
            texto: "A Revolução Cultural foi um movimento político ocorrido na:",
            respostas: ["Coreia do Sul", "URSS", "China", "Índia"],
            correta: 2
        },
        {
            texto: "A política de 'apartheid' vigorou oficialmente até:",
            respostas: ["1990", "1994", "1980", "2000"],
            correta: 1
        }
    ]
};

const tempoPorNivel = { 'facil': 20, 'medio': 30, 'dificil': 35, 'expert': 40 };
const pontosPorNivel = { 'facil': 10, 'medio': 20, 'dificil': 30, 'expert': 40 };

let estadoJogo = { nome: '', categoria: '', nivel: '', nivelId: 0, pontuacao: 0, perguntaAtual: 0 };
let timerInterval;
let tempoRestante = 30;
let jogoBloqueado = false;
let perguntasAtuais = [];
let nivelAtual = 'facil';

const savePlayer = (p) => localStorage.setItem('marioPlayer', JSON.stringify(p));

function tocarSomAcerto() {
    const a = new (window.AudioContext || window.webkitAudioContext)();
    const o = a.createOscillator();
    const g = a.createGain();
    o.connect(g); g.connect(a.destination);
    o.frequency.setValueAtTime(800, a.currentTime);
    o.frequency.exponentialRampToValueAtTime(1200, a.currentTime + 0.1);
    g.gain.setValueAtTime(0.3, a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.2);
    o.start(a.currentTime); o.stop(a.currentTime + 0.2);
}

function tocarSomErro() {
    const a = new (window.AudioContext || window.webkitAudioContext)();
    const o1 = a.createOscillator();
    const o2 = a.createOscillator();
    const g = a.createGain();
    o1.connect(g); o2.connect(g); g.connect(a.destination);
    o1.frequency.setValueAtTime(200, a.currentTime);
    o2.frequency.setValueAtTime(150, a.currentTime);
    g.gain.setValueAtTime(0.2, a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.4);
    o1.start(a.currentTime); o2.start(a.currentTime);
    o1.stop(a.currentTime + 0.4); o2.stop(a.currentTime + 0.4);
}

function atualizarHeader() {
    const nome = document.getElementById('nome-jogador');
    const pts = document.getElementById('pontuacao');
    if (nome) nome.textContent = `JOGADOR: ${estadoJogo.nome}`;
    if (pts) pts.textContent = estadoJogo.pontuacao;
}

function atualizarTimer() {
    document.getElementById('timer').textContent = `${tempoRestante}s`;
    document.getElementById('timer').classList.toggle('perigo', tempoRestante <= 5);
    document.getElementById('pergunta-texto').innerHTML = perguntasAtuais[estadoJogo.perguntaAtual].texto;
}

function iniciarTimer() {
    tempoRestante = tempoPorNivel[nivelAtual] || 30;
    atualizarTimer();
    timerInterval = setInterval(() => {
        tempoRestante--;
        atualizarTimer();
        if (tempoRestante <= 0) {
            clearInterval(timerInterval);
            respostaErradaPorTempo();
        }
    }, 1000);
}

function pararTimer() {
    clearInterval(timerInterval);
}

function carregarPergunta() {
    if (!perguntasPorNivel[estadoJogo.nivelId]) {
        document.getElementById('pergunta-texto').textContent = 'Erro: Nível não encontrado!';
        return;
    }
    perguntasAtuais = perguntasPorNivel[estadoJogo.nivelId];
    if (estadoJogo.perguntaAtual >= perguntasAtuais.length) {
        finalizarJogo();
        return;
    }
    const p = perguntasAtuais[estadoJogo.perguntaAtual];
    document.getElementById('pergunta-texto').innerHTML = p.texto;
    document.querySelectorAll('.escolha').forEach((d, i) => {
        d.querySelector('h1').textContent = p.respostas[i];
        d.classList.remove('resposta-correta', 'resposta-incorreta', 'selecionada');
        d.style.pointerEvents = 'auto';
        d.setAttribute('aria-pressed', 'false');
    });
    jogoBloqueado = false;
    iniciarTimer();
}

function checarResposta(e) {
    if (jogoBloqueado) return;
    jogoBloqueado = true;
    pararTimer();
    const d = e.currentTarget;
    const indice = Array.from(document.querySelectorAll('.escolha')).indexOf(d);
    const correta = perguntasAtuais[estadoJogo.perguntaAtual].correta;
    document.querySelectorAll('.escolha').forEach(x => x.style.pointerEvents = 'none');
    
    if (indice === correta) {
        const pontosNivel = pontosPorNivel[nivelAtual] || 10;
        estadoJogo.pontuacao += pontosNivel;
        d.classList.add('resposta-correta');
        d.setAttribute('aria-pressed', 'true');
        tocarSomAcerto();
    } else {
        d.classList.add('resposta-incorreta');
        document.querySelectorAll('.escolha')[correta].classList.add('resposta-correta');
        tocarSomErro();
    }
    
    atualizarHeader();
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        estadoJogo.perguntaAtual++;
        carregarPergunta();
    }, 2000);
}

function respostaErradaPorTempo() {
    if (jogoBloqueado) return;
    jogoBloqueado = true;
    tocarSomErro();
    const correta = perguntasAtuais[estadoJogo.perguntaAtual].correta;
    document.getElementById('pergunta-texto').innerHTML =
        perguntasAtuais[estadoJogo.perguntaAtual].texto + "<br><span style='color: #ff4444;'>Tempo esgotado!</span>";
    document.querySelectorAll('.escolha')[correta].classList.add('resposta-correta');
    document.querySelectorAll('.escolha').forEach(x => x.style.pointerEvents = 'none');
    atualizarHeader();
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        estadoJogo.perguntaAtual++;
        carregarPergunta();
    }, 2000);
}

function finalizarJogo() {
    pararTimer();
    const total = perguntasAtuais.length;
    const pontosNivel = pontosPorNivel[nivelAtual] || 10;
    const pontosMaximos = total * pontosNivel;
    const acertos = Math.round(estadoJogo.pontuacao / pontosNivel);
    
    document.getElementById('pergunta-texto').innerHTML =
        `Fim do jogo!<br>Pontuação: ${estadoJogo.pontuacao}/${pontosMaximos}<br>Você acertou ${acertos}/${total} perguntas!<br><small>Redirecionando...</small>`;
    document.querySelectorAll('.escolha').forEach(d => d.style.display = 'none');
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        window.location.href = '../index.html';
    }, 4000);
}

function voltarInicio() {
    const params = new URLSearchParams({
        player: estadoJogo.nome,
        score: estadoJogo.pontuacao,
        category: estadoJogo.categoria,
        nivel: estadoJogo.nivel
    });
    window.location.href = 'categorias.html?' + params.toString();
}

document.addEventListener('DOMContentLoaded', function () {
    const url = new URLSearchParams(window.location.search);
    estadoJogo.nome = decodeURIComponent(url.get('player') || 'MARIO');
    estadoJogo.categoria = url.get('category') || 'eventos';
    estadoJogo.nivel = url.get('nivel') || 'facil';
    estadoJogo.nivelId = { 'facil': 1, 'medio': 2, 'dificil': 3, 'expert': 4 }[estadoJogo.nivel] || 1;
    nivelAtual = estadoJogo.nivel;
    estadoJogo.pontuacao = parseInt(url.get('score') || '0');
    atualizarHeader();
    
    document.querySelectorAll('.escolha').forEach(d => {
        d.addEventListener('click', checarResposta);
        d.addEventListener('keydown', function (e) {
            if ((e.key === 'Enter' || e.key === ' ') && !jogoBloqueado) {
                e.preventDefault();
                checarResposta({ currentTarget: this });
            }
        });
    });
    carregarPergunta();
});
