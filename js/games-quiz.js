const perguntasPorNivel = {
    1: [
        {
            texto: "Qual é o mascote mais famoso da Nintendo?",
            respostas: ["Link", "Mario", "Kirby", "Yoshi"],
            correta: 1
        },
        {
            texto: "Em qual jogo aparece o personagem Sonic?",
            respostas: ["Sonic Heroes", "Mario Kart", "Zelda", "Crash Bandicoot"],
            correta: 0
        },
        {
            texto: "Que tipo de jogo é Minecraft?",
            respostas: ["Corrida", "Tiro", "Sandbox", "Simulador"],
            correta: 2
        },
        {
            texto: "Qual é o console que veio antes do PS5?",
            respostas: ["PS3", "PS2", "PS4", "PS Vita"],
            correta: 2
        },
        {
            texto: "Em Among Us, o inimigo é chamado de:",
            respostas: ["Traidor", "Impostor", "Sabotador", "Zumbi"],
            correta: 1
        },
        {
            texto: "Qual jogo tem criaturas chamadas Creepers?",
            respostas: ["Terraria", "Fortnite", "Minecraft", "Roblox"],
            correta: 2
        },
        {
            texto: "FIFA é um jogo de qual esporte?",
            respostas: ["Basquete", "Corrida", "Futebol", "Tênis"],
            correta: 2
        },
        {
            texto: "Quem é o protagonista de God of War?",
            respostas: ["Ares", "Kratos", "Zeus", "Hades"],
            correta: 1
        },
        {
            texto: "Em Mario Kart, os jogadores pilotam:",
            respostas: ["Skates", "Carros", "Naves", "Motos aquáticas"],
            correta: 1
        },
        {
            texto: "Roblox é conhecido como:",
            respostas: ["Um jogo", "Uma plataforma de criação", "Um simulador", "Um app educativo"],
            correta: 1
        }
    ],

    2: [
        {
            texto: "Em Fortnite, qual estrutura é usada para ganhar vantagem de altura?",
            respostas: ["Parede", "Ponte", "Rampa", "Torre"],
            correta: 2
        },
        {
            texto: "A frase 'The cake is a lie' é de qual jogo?",
            respostas: ["Half-Life", "Portal", "Doom", "Overwatch"],
            correta: 1
        },
        {
            texto: "Pikachu é de qual tipo?",
            respostas: ["Água", "Fogo", "Elétrico", "Voador"],
            correta: 2
        },
        {
            texto: "League of Legends é um jogo do gênero:",
            respostas: ["FPS", "MOBA", "Battle Royale", "Puzzle"],
            correta: 1
        },
        {
            texto: "The Legend of Zelda é produzido por qual empresa?",
            respostas: ["Sony", "Microsoft", "Nintendo", "Sega"],
            correta: 2
        },
        {
            texto: "Qual jogo famoso nasceu de um mod de Warcraft III?",
            respostas: ["Valorant", "DotA", "Skyrim", "PUBG"],
            correta: 1
        },
        {
            texto: "A história de The Witcher 3 ocorre no continente chamado:",
            respostas: ["Tamriel", "Thedas", "Gaia", "Continent"],
            correta: 3
        },
        {
            texto: "Em GTA V, quantos protagonistas existem?",
            respostas: ["Um", "Dois", "Três", "Quatro"],
            correta: 2
        },
        {
            texto: "Red Dead Redemption é ambientado em qual cenário?",
            respostas: ["Idade Média", "Futuro", "Velho Oeste", "Roma Antiga"],
            correta: 2
        },
        {
            texto: "Qual empresa criou o console Xbox?",
            respostas: ["Sony", "Microsoft", "Nintendo", "Atari"],
            correta: 1
        }
    ],

    3: [
        {
            texto: "Qual jogo é famoso por sua dificuldade e pela frase 'You Died'?",
            respostas: ["Dark Souls", "Elden Ring", "Doom", "Sekiro"],
            correta: 0
        },
        {
            texto: "Qual destes NÃO é um jogo da franquia Zelda?",
            respostas: ["Majora's Mask", "Breath of the Wild", "Twilight Princess", "Ghost of Tsushima"],
            correta: 3
        },
        {
            texto: "Em Overwatch, qual personagem é conhecido por dizer 'Cheers, love! The cavalry's here!'?",
            respostas: ["Mercy", "Tracer", "D.Va", "Sombra"],
            correta: 1
        },
        {
            texto: "The Last of Us foi desenvolvido por qual estúdio?",
            respostas: ["Ubisoft", "Naughty Dog", "EA", "Capcom"],
            correta: 1
        },
        {
            texto: "Em Skyrim, os jogadores pertencem a qual raça de dragão?",
            respostas: ["Dragonfolk", "Dovahkiin", "Dragorian", "Nordborn"],
            correta: 1
        },
        {
            texto: "O jogo Hollow Knight se passa em:",
            respostas: ["Hallownest", "Valoran", "Midgard", "Gaia"],
            correta: 0
        },
        {
            texto: "Qual jogo popular usa o motor gráfico Source?",
            respostas: ["Halo", "Counter-Strike: Global Offensive", "Far Cry", "Valorant"],
            correta: 1
        },
        {
            texto: "O criador de Metal Gear Solid se chama:",
            respostas: ["Shigeru Miyamoto", "Hideo Kojima", "Hideki Kamiya", "Tetsuya Nomura"],
            correta: 1
        },
        {
            texto: "Qual é o nome do reino principal em Final Fantasy XV?",
            respostas: ["Lucis", "Spira", "Midgar", "Pulse"],
            correta: 0
        },
        {
            texto: "Qual personagem é considerado o 'pai dos FPS modernos'?",
            respostas: ["Master Chief", "Doomguy", "Gordon Freeman", "B.J. Blazkowicz"],
            correta: 1
        }
    ],

    4: [
        {
            texto: "Em Bloodborne, qual é o nome da cidade principal?",
            respostas: ["Boletaria", "Yharnam", "Drangleic", "Lordran"],
            correta: 1
        },
        {
            texto: "Qual jogo introduziu o conceito moderno de 'open world' em 2001?",
            respostas: ["GTA III", "Zelda Ocarina of Time", "Morrowind", "Fallout"],
            correta: 0
        },
        {
            texto: "Em Elden Ring, o jogador é chamado de:",
            respostas: ["Hollow", "Tarnished", "Ashen One", "Hunter"],
            correta: 1
        },
        {
            texto: "Silent Hill foi criado por qual estúdio?",
            respostas: ["Konami", "Capcom", "Square Enix", "Bandai Namco"],
            correta: 0
        },
        {
            texto: "Qual foi o primeiro console vendido pela Sony?",
            respostas: ["PS1", "PSX", "PlayStation Classic", "PS Portable"],
            correta: 1
        },
        {
            texto: "O jogo Chrono Trigger foi lançado originalmente para:",
            respostas: ["NES", "SNES", "PlayStation 2", "Nintendo 64"],
            correta: 1
        },
        {
            texto: "Em Mass Effect, qual é o nome da raça que criou os Reapers?",
            respostas: ["Quarians", "Leviathans", "Asari", "Turians"],
            correta: 1
        },
        {
            texto: "A engine RE Engine pertence a qual empresa?",
            respostas: ["Capcom", "EA", "Epic Games", "Activision"],
            correta: 0
        },
        {
            texto: "O criador de Death Stranding também criou:",
            respostas: ["Dark Souls", "Devil May Cry", "Metal Gear", "Shenmue"],
            correta: 2
        },
        {
            texto: "Qual jogo é conhecido por ter mais de 1.000 finais possíveis?",
            respostas: ["Undertale", "Nier Automata", "Chrono Cross", "The Stanley Parable"],
            correta: 3
        }
    ]
};

const tempoPorNivel = { 'facil': 20, 'medio': 30, 'dificil': 35, 'expert': 40 };

let estadoJogo = { nome: '', categoria: '', nivel: '', nivelId: 0, pontuacao: 0, perguntaAtual: 0 };
let timerInterval;
let tempoRestante = 30;
let jogoBloqueado = false;
let perguntasAtuais = [];
let nivelAtual = 'facil';

const savePlayer = (p) => localStorage.setItem('marioPlayer', JSON.stringify(p));

function tocarSomAcerto() {
    const a = new (window.AudioContext || window.webkitAudioContext)();
    const o = a.createOscillator();
    const g = a.createGain();
    o.connect(g); g.connect(a.destination);
    o.frequency.setValueAtTime(800, a.currentTime);
    o.frequency.exponentialRampToValueAtTime(1200, a.currentTime + 0.1);
    g.gain.setValueAtTime(0.3, a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.2);
    o.start(a.currentTime); o.stop(a.currentTime + 0.2);
}

function tocarSomErro() {
    const a = new (window.AudioContext || window.webkitAudioContext)();
    const o1 = a.createOscillator();
    const o2 = a.createOscillator();
    const g = a.createGain();
    o1.connect(g); o2.connect(g); g.connect(a.destination);
    o1.frequency.setValueAtTime(200, a.currentTime);
    o2.frequency.setValueAtTime(150, a.currentTime);
    g.gain.setValueAtTime(0.2, a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, a.currentTime + 0.4);
    o1.start(a.currentTime); o2.start(a.currentTime);
    o1.stop(a.currentTime + 0.4); o2.stop(a.currentTime + 0.4);
}

function atualizarHeader() {
    const nome = document.getElementById('nome-jogador');
    const pts = document.getElementById('pontuacao');
    if (nome) nome.textContent = `JOGADOR: ${estadoJogo.nome}`;
    if (pts) pts.textContent = estadoJogo.pontuacao;
}

function atualizarTimer() {
    document.getElementById('timer').textContent = `${tempoRestante}s`;
    document.getElementById('timer').classList.toggle('perigo', tempoRestante <= 5);
    document.getElementById('pergunta-texto').innerHTML = perguntasAtuais[estadoJogo.perguntaAtual].texto;
}

function iniciarTimer() {
    tempoRestante = tempoPorNivel[nivelAtual] || 30;
    atualizarTimer();
    timerInterval = setInterval(() => {
        tempoRestante--;
        atualizarTimer();
        if (tempoRestante <= 0) {
            clearInterval(timerInterval);
            respostaErradaPorTempo();
        }
    }, 1000);
}

function pararTimer() {
    clearInterval(timerInterval);
}

function carregarPergunta() {
    if (!perguntasPorNivel[estadoJogo.nivelId]) {
        document.getElementById('pergunta-texto').textContent = 'Erro: Nível não encontrado!';
        return;
    }
    perguntasAtuais = perguntasPorNivel[estadoJogo.nivelId];
    if (estadoJogo.perguntaAtual >= perguntasAtuais.length) {
        finalizarJogo();
        return;
    }
    const p = perguntasAtuais[estadoJogo.perguntaAtual];
    document.getElementById('pergunta-texto').innerHTML = p.texto;
    document.querySelectorAll('.escolha').forEach((d, i) => {
        d.querySelector('h1').textContent = p.respostas[i];
        d.classList.remove('resposta-correta', 'resposta-incorreta', 'selecionada');
        d.style.pointerEvents = 'auto';
        d.setAttribute('aria-pressed', 'false');
    });
    jogoBloqueado = false;
    iniciarTimer();
}

function checarResposta(e) {
    if (jogoBloqueado) return;
    jogoBloqueado = true;
    pararTimer();
    const d = e.currentTarget;
    const indice = Array.from(document.querySelectorAll('.escolha')).indexOf(d);
    const correta = perguntasAtuais[estadoJogo.perguntaAtual].correta;
    document.querySelectorAll('.escolha').forEach(x => x.style.pointerEvents = 'none');
    if (indice === correta) {
        estadoJogo.pontuacao += 10;
        d.classList.add('resposta-correta');
        d.setAttribute('aria-pressed', 'true');
        tocarSomAcerto();
    } else {
        d.classList.add('resposta-incorreta');
        document.querySelectorAll('.escolha')[correta].classList.add('resposta-correta');
        tocarSomErro();
    }
    atualizarHeader();
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        estadoJogo.perguntaAtual++;
        carregarPergunta();
    }, 2000);
}

function respostaErradaPorTempo() {
    if (jogoBloqueado) return;
    jogoBloqueado = true;
    tocarSomErro();
    const correta = perguntasAtuais[estadoJogo.perguntaAtual].correta;
    document.getElementById('pergunta-texto').innerHTML =
        perguntasAtuais[estadoJogo.perguntaAtual].texto + "<br><span style='color: #ff4444;'>Tempo esgotado!</span>";
    document.querySelectorAll('.escolha')[correta].classList.add('resposta-correta');
    document.querySelectorAll('.escolha').forEach(x => x.style.pointerEvents = 'none');
    atualizarHeader();
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        estadoJogo.perguntaAtual++;
        carregarPergunta();
    }, 2000);
}

function finalizarJogo() {
    pararTimer();
    const total = perguntasAtuais.length;
    document.getElementById('pergunta-texto').innerHTML =
        `Fim do jogo!<br>Pontuação: ${estadoJogo.pontuacao}/${total * 10}<br>Você acertou ${Math.round(estadoJogo.pontuacao / 10)}/${total} perguntas!<br><small>Redirecionando...</small>`;
    document.querySelectorAll('.escolha').forEach(d => d.style.display = 'none');
    savePlayer({ name: estadoJogo.nome, score: estadoJogo.pontuacao });
    setTimeout(() => {
        window.location.href = '../index.html';
    }, 4000);
}

function voltarInicio() {
    const params = new URLSearchParams({
        player: estadoJogo.nome,
        score: estadoJogo.pontuacao,
        category: estadoJogo.categoria,
        nivel: estadoJogo.nivel
    });
    window.location.href = 'categorias.html?' + params.toString();
}

document.addEventListener('DOMContentLoaded', function () {
    const url = new URLSearchParams(window.location.search);
    estadoJogo.nome = decodeURIComponent(url.get('player') || 'MARIO');
    estadoJogo.categoria = url.get('category') || 'automobilismo';
    estadoJogo.nivel = url.get('nivel') || 'facil';
    estadoJogo.nivelId = { 'facil': 1, 'medio': 2, 'dificil': 3, 'expert': 4 }[estadoJogo.nivel] || 1;
    nivelAtual = estadoJogo.nivel;
    estadoJogo.pontuacao = parseInt(url.get('score') || '0');
    atualizarHeader();
    document.querySelectorAll('.escolha').forEach(d => {
        d.addEventListener('click', checarResposta);
        d.addEventListener('keydown', function (e) {
            if ((e.key === 'Enter' || e.key === ' ') && !jogoBloqueado) {
                e.preventDefault();
                checarResposta({ currentTarget: this });
            }
        });
    });
    carregarPergunta();
});